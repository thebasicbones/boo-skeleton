# Design Document

## Overview

This system is a full-stack web application consisting of a FastAPI backend with RESTful endpoints for CRUD operations and a lightweight HTML/CSS/JavaScript frontend. The core feature is a topological sort capability that orders resources based on their dependency relationships, ensuring that dependencies always appear before their dependents.

The backend uses FastAPI for high-performance async request handling, SQLAlchemy for database ORM, and implements a custom topological sort algorithm for dependency resolution. The frontend provides an intuitive interface for managing resources and visualizing dependency relationships.

## Architecture

### System Components

```
┌─────────────────────────────────────────────────────────────┐
│                      Web Browser                             │
│  ┌────────────────────────────────────────────────────┐    │
│  │         Frontend (HTML/CSS/JavaScript)              │    │
│  │  - Resource List View                               │    │
│  │  - CRUD Forms                                       │    │
│  │  - Search Bar with Topological Sort                 │    │
│  │  - Dependency Visualization                         │    │
│  └────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ HTTP/JSON
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    FastAPI Backend                           │
│  ┌────────────────────────────────────────────────────┐    │
│  │              API Layer (Routers)                    │    │
│  │  - POST   /api/resources                            │    │
│  │  - GET    /api/resources                            │    │
│  │  - GET    /api/resources/{id}                       │    │
│  │  - PUT    /api/resources/{id}                       │    │
│  │  - DELETE /api/resources/{id}                       │    │
│  │  - GET    /api/search?q=...                         │    │
│  └────────────────────────────────────────────────────┘    │
│                            │                                 │
│  ┌────────────────────────────────────────────────────┐    │
│  │           Business Logic Layer                      │    │
│  │  - Resource Service                                 │    │
│  │  - Topological Sort Service                         │    │
│  │  - Validation Service                               │    │
│  └────────────────────────────────────────────────────┘    │
│                            │                                 │
│  ┌────────────────────────────────────────────────────┐    │
│  │           Data Access Layer                         │    │
│  │  - Resource Repository                              │    │
│  │  - Database Models (SQLAlchemy)                     │    │
│  └────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    SQLite Database                           │
│  - resources table                                           │
│  - resource_dependencies table (junction)                    │
└─────────────────────────────────────────────────────────────┘
```

### Technology Stack

- **Backend**: FastAPI (Python 3.10+)
- **Database**: SQLite with SQLAlchemy ORM
- **Frontend**: HTML5, CSS3, Vanilla JavaScript
- **API Documentation**: OpenAPI/Swagger (auto-generated by FastAPI)

## Components and Interfaces

### Backend Components

#### 1. API Router (`app/routers/resources.py`)

Defines the six REST endpoints:

```python
POST   /api/resources          # Create resource
GET    /api/resources          # List all resources
GET    /api/resources/{id}     # Get single resource
PUT    /api/resources/{id}     # Update resource
DELETE /api/resources/{id}     # Delete resource (with cascade option)
GET    /api/search             # Search with topological sort
```

#### 2. Pydantic Models (`app/schemas.py`)

Request/response validation schemas:

- `ResourceCreate`: Validation for creating resources (name, description, dependencies)
- `ResourceUpdate`: Validation for updating resources
- `ResourceResponse`: Response format with id, name, description, dependencies, created_at
- `ResourceList`: List of resources with topological order metadata
- `ErrorResponse`: Standardized error format

#### 3. Database Models (`app/models.py`)

SQLAlchemy ORM models:

- `Resource`: Main resource table (id, name, description, created_at, updated_at)
- `ResourceDependency`: Junction table for many-to-many dependencies (resource_id, depends_on_id)

#### 4. Service Layer (`app/services/`)

- `ResourceService`: Business logic for CRUD operations
- `TopologicalSortService`: Implements Kahn's algorithm for dependency ordering
- `ValidationService`: Custom validation logic beyond Pydantic

#### 5. Repository Layer (`app/repositories/resource_repository.py`)

Data access abstraction:

- `get_all()`: Retrieve all resources with dependencies
- `get_by_id(id)`: Retrieve single resource
- `create(data)`: Insert new resource
- `update(id, data)`: Update existing resource
- `delete(id, cascade)`: Delete resource with optional cascade
- `search(query)`: Search resources by name/description

### Frontend Components

#### 1. Main HTML (`static/index.html`)

Single-page structure with sections:

- Header with title
- Search bar section
- Resource list/grid display
- Create/Edit modal form
- Delete confirmation modal

#### 2. Styles (`static/styles.css`)

- Clean, minimal design
- Responsive layout
- Visual indicators for dependencies
- Loading states and animations
- Form styling

#### 3. JavaScript (`static/app.js`)

- API client functions (fetch wrappers)
- DOM manipulation for CRUD operations
- Search and topological sort visualization
- Dependency graph rendering
- Event handlers for user interactions

## Data Models

### Resource Entity

```python
{
  "id": "uuid",
  "name": "string (required, max 100 chars)",
  "description": "string (optional, max 500 chars)",
  "dependencies": ["uuid"],  # List of resource IDs this depends on
  "created_at": "datetime",
  "updated_at": "datetime"
}
```

### Dependency Relationship

- Directed edge from Resource A to Resource B means "A depends on B"
- Must form a Directed Acyclic Graph (DAG)
- Circular dependencies are invalid and rejected

### Database Schema

```sql
CREATE TABLE resources (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE resource_dependencies (
    resource_id TEXT NOT NULL,
    depends_on_id TEXT NOT NULL,
    PRIMARY KEY (resource_id, depends_on_id),
    FOREIGN KEY (resource_id) REFERENCES resources(id) ON DELETE CASCADE,
    FOREIGN KEY (depends_on_id) REFERENCES resources(id) ON DELETE CASCADE
);

CREATE INDEX idx_dependencies_resource ON resource_dependencies(resource_id);
CREATE INDEX idx_dependencies_depends_on ON resource_dependencies(depends_on_id);
```


## Correctness Properties

*A property is a characteristic or behavior that should hold true across all valid executions of a system—essentially, a formal statement about what the system should do. Properties serve as the bridge between human-readable specifications and machine-verifiable correctness guarantees.*

### Backend API Properties

**Property 1: Resource creation round-trip**
*For any* valid resource data, creating a resource via POST and then retrieving it via GET should return equivalent resource data with a unique identifier assigned.
**Validates: Requirements 1.1, 2.1**

**Property 2: Invalid data rejection**
*For any* invalid resource data (missing required fields, wrong types, invalid dependencies), the API should reject the request with an HTTP 422 status code and detailed validation error.
**Validates: Requirements 1.2, 6.1, 6.2, 6.3**

**Property 3: Successful creation returns 201**
*For any* valid resource creation request, the API should return HTTP 201 status code with the created resource.
**Validates: Requirements 1.4**

**Property 4: List all resources completeness**
*For any* set of N created resources, the GET /api/resources endpoint should return all N resources.
**Validates: Requirements 2.3**

**Property 5: Update persistence**
*For any* existing resource and valid update data, updating the resource via PUT and then retrieving it should return the updated data.
**Validates: Requirements 3.1**

**Property 6: Successful update returns 200**
*For any* valid resource update request, the API should return HTTP 200 status code with the updated resource.
**Validates: Requirements 3.4**

**Property 7: Delete removes resource**
*For any* existing resource, deleting it via DELETE and then attempting to retrieve it should return HTTP 404.
**Validates: Requirements 4.1**

**Property 8: Successful delete returns 204**
*For any* successful delete operation, the API should return HTTP 204 status code.
**Validates: Requirements 4.3**

**Property 9: Topological sort ordering**
*For any* set of resources with dependency relationships forming a DAG, the search endpoint should return results where all dependencies appear before their dependents.
**Validates: Requirements 5.1**

**Property 10: Successful search returns 200**
*For any* valid search request, the API should return HTTP 200 status code with topologically sorted results.
**Validates: Requirements 5.5**

**Property 11: Consistent error format**
*For any* error response across all endpoints, the response should follow the same JSON structure with consistent fields (error, message, details).
**Validates: Requirements 7.4**

**Property 12: Cascade delete removes dependents**
*For any* resource with downstream dependencies, deleting with cascade=true should remove the resource and all resources that depend on it (directly or transitively).
**Validates: Requirements 11.2**

**Property 13: Non-cascade delete preserves dependents**
*For any* resource with downstream dependencies, deleting with cascade=false should remove only the specified resource and leave dependents intact (updating their dependency lists).
**Validates: Requirements 11.3**

### Frontend Properties

**Property 14: Resource display completeness**
*For any* resource returned by the API, the frontend should display all relevant attributes (id, name, description, dependencies).
**Validates: Requirements 8.4**

**Property 15: Create form submission**
*For any* valid form data submitted through the create form, the frontend should send a POST request to the API and display the newly created resource in the list.
**Validates: Requirements 9.1, 9.4**

**Property 16: Dependency inclusion in create**
*For any* resource created with dependencies specified, the create request payload should include the dependency IDs.
**Validates: Requirements 9.2**

**Property 17: Error message display**
*For any* API error response (validation, not found, server error), the frontend should display the error message to the user.
**Validates: Requirements 9.3**

**Property 18: Edit form population**
*For any* resource selected for editing, the edit form should be populated with the current resource data.
**Validates: Requirements 10.1**

**Property 19: Update form submission**
*For any* valid update data submitted through the edit form, the frontend should send a PUT request to the API and update the displayed resource.
**Validates: Requirements 10.2**

**Property 20: Dependency modification in update**
*For any* resource update that modifies dependencies, the update request payload should include the modified dependency list.
**Validates: Requirements 10.3**

**Property 21: Delete removes from UI**
*For any* successfully deleted resource, the frontend should remove the resource from the displayed list.
**Validates: Requirements 11.5**

**Property 22: Search displays topological order**
*For any* search query, the frontend should display results in the topological order returned by the API.
**Validates: Requirements 12.1**

## Error Handling

### Backend Error Handling

**Validation Errors (HTTP 422)**
- Missing required fields
- Invalid data types
- Invalid dependency references (non-existent resource IDs)
- Circular dependency detection

**Not Found Errors (HTTP 404)**
- Resource ID does not exist
- Attempting to update/delete non-existent resource

**Conflict Errors (HTTP 409)**
- Circular dependency would be created
- Dependency constraint violation

**Server Errors (HTTP 500)**
- Database connection failures
- Unexpected exceptions
- Logged with full stack trace for debugging

**Error Response Format**
```json
{
  "error": "ValidationError",
  "message": "Human-readable error description",
  "details": {
    "field": "Specific field error details"
  }
}
```

### Frontend Error Handling

- Display error messages in a prominent, user-friendly manner
- Show validation errors inline on form fields when possible
- Display toast/alert notifications for operation results
- Handle network errors gracefully with retry options
- Show loading states during API calls

## Testing Strategy

### Unit Testing

The system will use **pytest** for backend unit tests and **Jest** (or similar) for frontend JavaScript tests.

**Backend Unit Tests:**
- Test individual service functions (CRUD operations, topological sort)
- Test repository layer with in-memory database
- Test validation logic
- Test error handling paths
- Mock external dependencies

**Frontend Unit Tests:**
- Test API client functions
- Test DOM manipulation functions
- Test form validation
- Test event handlers

### Property-Based Testing

The system will use **Hypothesis** (Python) for backend property-based testing.

**Configuration:**
- Each property test should run a minimum of 100 iterations
- Each test must be tagged with a comment referencing the design document property
- Tag format: `# Feature: fastapi-crud-backend, Property {number}: {property_text}`

**Backend Property Tests:**
- Generate random valid resources and test CRUD round-trips
- Generate invalid data and verify rejection
- Generate dependency graphs and verify topological sort correctness
- Generate cascade delete scenarios and verify correct removal
- Test that all error responses follow consistent format

**Frontend Property Tests:**
- Generate random resources and verify display completeness
- Generate random form inputs and verify API calls
- Generate error responses and verify display

**Key Property Testing Patterns:**

1. **Round-trip properties**: Create → Read should return equivalent data
2. **Invariants**: Topological sort always has dependencies before dependents
3. **Error conditions**: Invalid inputs always rejected with proper error codes
4. **Idempotence**: Multiple identical requests produce same result
5. **Cascade operations**: Delete with cascade removes all dependents

### Integration Testing

- Test full request/response cycle through FastAPI test client
- Test database transactions and rollbacks
- Test frontend-backend integration with mock API responses
- Test end-to-end user workflows (create → update → delete)

## Implementation Notes

### Topological Sort Algorithm

Use **Kahn's Algorithm** for topological sorting:

1. Calculate in-degree for each node (number of dependencies)
2. Add all nodes with in-degree 0 to a queue
3. While queue is not empty:
   - Remove node from queue and add to result
   - For each dependent of this node, decrease its in-degree
   - If dependent's in-degree becomes 0, add to queue
4. If result contains all nodes, return result
5. Otherwise, circular dependency exists (error)

**Time Complexity**: O(V + E) where V is vertices (resources) and E is edges (dependencies)

### Circular Dependency Detection

Circular dependencies are detected and prevented at multiple points:

**During Create/Update Operations:**
- Before saving a new resource or updating dependencies, the system validates the entire dependency graph
- The validation runs a topological sort on the graph that would result after the operation
- If the topological sort fails (doesn't include all nodes), a cycle exists
- The operation is rejected with HTTP 422 and a detailed error message

**Detection Algorithm:**
1. Build a temporary graph including the proposed changes
2. Run Kahn's algorithm on the temporary graph
3. If the sorted result has fewer nodes than the graph, a cycle exists
4. Identify the cycle path using DFS (Depth-First Search) for error reporting
5. Return error with cycle path: "Circular dependency: A → B → C → A"

**Examples of Circular Dependencies:**

*Direct cycle:*
```
Resource A depends on Resource B
Resource B depends on Resource A
```

*Indirect cycle:*
```
Resource A depends on Resource B
Resource B depends on Resource C
Resource C depends on Resource D
Resource D depends on Resource A
```

*Self-dependency:*
```
Resource A depends on Resource A
```

All of these scenarios will be rejected during validation, ensuring the dependency graph always remains a valid DAG (Directed Acyclic Graph).

### Database Considerations

- Use SQLite for simplicity (can be swapped for PostgreSQL in production)
- Enable foreign key constraints
- Use CASCADE on foreign keys for dependency cleanup
- Add indexes on dependency lookup columns
- Use transactions for multi-step operations (cascade delete)

### Frontend Architecture

- Single-page application (SPA) pattern
- Vanilla JavaScript (no framework) for simplicity
- Fetch API for HTTP requests
- Event delegation for dynamic content
- Local state management (no complex state library needed)

### API Design Principles

- RESTful resource-oriented URLs
- Consistent JSON request/response formats
- Proper HTTP status codes
- CORS enabled for frontend access
- OpenAPI documentation auto-generated by FastAPI
- Request/response validation via Pydantic models
